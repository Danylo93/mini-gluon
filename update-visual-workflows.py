#!/usr/bin/env python3
"""
Script para atualizar os workflows com visualiza√ß√£o EXATA como no GitHub Actions
"""

import re

# Workflows com visualiza√ß√£o EXATA como no GitHub Actions
VISUAL_WORKFLOWS = {
    "ci.yml": '''name: üöÄ CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  # SEQU√äNCIA 1: Jobs sequenciais conectados
  job1:
    name: üì• Checkout & Setup
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üì¶ Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: üìã Setup summary
      run: |
        echo "‚úÖ Setup completed successfully!"
        echo "‚òï Java 17 configured"
        echo "üì¶ Maven dependencies cached"

  job2:
    name: üî® Build & Compile
    runs-on: ubuntu-latest
    needs: job1  # üîó DEPEND√äNCIA: Executa AP√ìS job1
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üîç Validate POM
      run: mvn validate
    
    - name: üßπ Clean workspace
      run: mvn clean
    
    - name: üî® Compile code
      run: mvn compile -DskipTests
    
    - name: üèóÔ∏è Build package
      run: mvn package -DskipTests
      env:
        MAVEN_OPTS: -Xmx1024m
    
    - name: üì§ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: target/*.jar
        retention-days: 30
    
    - name: üìã Build summary
      run: |
        echo "‚úÖ Build completed successfully!"
        echo "üì¶ Artifacts: $(ls -la target/*.jar)"

  job3:
    name: üß™ Test & Quality
    runs-on: ubuntu-latest
    needs: job2  # üîó DEPEND√äNCIA: Executa AP√ìS job2
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üß™ Run unit tests
      run: mvn test
      env:
        MAVEN_OPTS: -Xmx1024m
    
    - name: üìä Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit
    
    - name: üìã Test summary
      run: |
        echo "‚úÖ Tests completed successfully!"
        echo "üìä Test reports generated"

  # SEQU√äNCIA 2: Jobs paralelos (executam juntos)
  job4:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: job3  # üîó DEPEND√äNCIA: Executa AP√ìS job3
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üîç OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: '{project_name}'
        path: '.'
        format: 'HTML'
        args: >
          --enableRetired
          --enableExperimental
          --failOnCVSS 7
    
    - name: üö® CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: java
    
    - name: üîç Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
    
    - name: üì§ Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          reports/
          .github/codeql/
        retention-days: 30
    
    - name: üìã Security summary
      run: |
        echo "üîí Security scan completed!"
        echo "üìä Reports generated in reports/ directory"

  job5:
    name: üéØ Code Quality
    runs-on: ubuntu-latest
    needs: job3  # üîó DEPEND√äNCIA: Executa AP√ìS job3 (em paralelo com job4)
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üì¶ Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: üßπ Clean workspace
      run: mvn clean
    
    - name: üîç SonarQube Analysis
      uses: sonarqube-quality-gate-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey={project_name}
          -Dsonar.organization=your-org
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.java.binaries=target/classes
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
    
    - name: üêõ SpotBugs Analysis
      run: mvn spotbugs:check
      continue-on-error: true
    
    - name: üìè Checkstyle Analysis
      run: mvn checkstyle:check
      continue-on-error: true
    
    - name: üìä JaCoCo Coverage
      run: mvn jacoco:report
      continue-on-error: true
    
    - name: üì§ Upload quality reports
      uses: actions/upload-artifact@v4
      with:
        name: quality-reports
        path: |
          target/site/
          target/spotbugsXml.xml
          target/checkstyle-result.xml
        retention-days: 30
    
    - name: üìã Quality summary
      run: |
        echo "üéØ Code quality analysis completed!"
        echo "üìä Reports available in target/site/"

  job6:
    name: üöÄ Deploy
    runs-on: ubuntu-latest
    needs: [job4, job5]  # üîó DEPEND√äNCIA: Executa AP√ìS job4 E job5 (ambos em paralelo)
    
    if: github.ref == 'refs/heads/main'  # S√≥ executa na branch main
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üì• Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: ./artifacts
    
    - name: üöÄ Deploy to staging
      run: |
        echo "üöÄ Deploying to staging environment..."
        echo "üì¶ Artifacts ready: $(ls -la ./artifacts/)"
        echo "‚úÖ All quality gates passed!"
        echo "üîí Security scan completed!"
        echo "üéØ Code quality analysis passed!"
    
    - name: üìã Deploy summary
      run: |
        echo "üéâ Deploy completed successfully!"
        echo "üåê Application deployed to staging"
        echo "üìä All workflows executed successfully"''',

    "security.yml": '''name: üîí Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM
  workflow_dispatch:

jobs:
  security-scan:
    name: üõ°Ô∏è Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üîç OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: '{project_name}'
        path: '.'
        format: 'HTML'
        args: >
          --enableRetired
          --enableExperimental
          --failOnCVSS 7
    
    - name: üö® CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: java
    
    - name: üîç Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
    
    - name: üì§ Upload security reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          reports/
          .github/codeql/
        retention-days: 30
    
    - name: üìã Security summary
      run: |
        echo "üîí Security scan completed!"
        echo "üìä Reports generated in reports/ directory"''',

    "quality.yml": '''name: üéØ Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  code-quality:
    name: üîç Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üì¶ Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: üßπ Clean workspace
      run: mvn clean
    
    - name: üîç SonarQube Analysis
      uses: sonarqube-quality-gate-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey={project_name}
          -Dsonar.organization=your-org
          -Dsonar.host.url=https://sonarcloud.io
          -Dsonar.java.binaries=target/classes
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
    
    - name: üêõ SpotBugs Analysis
      run: mvn spotbugs:check
      continue-on-error: true
    
    - name: üìè Checkstyle Analysis
      run: mvn checkstyle:check
      continue-on-error: true
    
    - name: üìä JaCoCo Coverage
      run: mvn jacoco:report
      continue-on-error: true
    
    - name: üì§ Upload quality reports
      uses: actions/upload-artifact@v4
      with:
        name: quality-reports
        path: |
          target/site/
          target/spotbugsXml.xml
          target/checkstyle-result.xml
        retention-days: 30
    
    - name: üìã Quality summary
      run: |
        echo "üéØ Code quality analysis completed!"
        echo "üìä Reports available in target/site/"''',

    "dependabot.yml": '''name: üîÑ Dependency Update

on:
  schedule:
    - cron: '0 9 * * 1' # Weekly on Monday at 9 AM
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - major
          - minor
          - patch

jobs:
  check-dependencies:
    name: üì¶ Check Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üì¶ Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: üîç Check for outdated dependencies
      run: |
        echo "Checking for outdated dependencies..."
        mvn versions:display-dependency-updates
        mvn versions:display-plugin-updates
    
    - name: üìù Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: update dependencies'
        title: 'üîÑ Automated dependency updates'
        body: |
          ## üîÑ Automated Dependency Updates
          
          This PR contains automated dependency updates for:
          - Maven dependencies
          - Maven plugins
          - Build tools
          
          ### üìã Changes
          - Updated outdated dependencies to latest versions
          - Improved security and performance
          
          ### ‚úÖ Checklist
          - [ ] Review dependency changes
          - [ ] Run tests locally
          - [ ] Check for breaking changes
          - [ ] Merge if everything looks good
          
          **Generated by:** Scaffold Forge Dependency Update Workflow
        branch: automated-dependency-updates
        delete-branch: true
    
    - name: üìã Update summary
      run: |
        echo "üîÑ Dependency update check completed!"
        echo "üìù Pull request created if updates available"''',

    "release.yml": '''name: üöÄ Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - prerelease
          - draft

env:
  JAVA_VERSION: '17'
  MAVEN_OPTS: '-Xmx1024m'

jobs:
  # SEQU√äNCIA 1: Jobs sequenciais conectados
  build-and-test:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java-version: [17, 21]
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ‚òï Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
        cache: maven
    
    - name: üì¶ Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
    
    - name: üßπ Clean workspace
      run: mvn clean
    
    - name: üèóÔ∏è Build release
      run: mvn package -DskipTests
      env:
        MAVEN_OPTS: -Xmx1024m
    
    - name: üì§ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-java${{ matrix.java-version }}
        path: target/*.jar
        retention-days: 30

  # SEQU√äNCIA 2: Jobs paralelos (executam juntos)
  security-check:
    name: üîí Security Check
    runs-on: ubuntu-latest
    needs: build-and-test  # üîó DEPEND√äNCIA
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: ‚òï Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: üîç Quick security scan
      run: |
        echo "üîí Running quick security scan for release..."
        mvn dependency:tree
        echo "‚úÖ Security check passed!"

  create-release:
    name: üéâ Create Release
    runs-on: ubuntu-latest
    needs: [build-and-test, security-check]  # üîó DEPEND√äNCIA: Executa AP√ìS ambos
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: üì• Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts-java17
        path: ./artifacts
    
    - name: üè∑Ô∏è Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: üìù Generate changelog
      id: changelog
      run: |
        echo "changelog=## üéâ Release ${{ steps.version.outputs.version }}
        
        ### ‚ú® Features
        - New features and improvements
        
        ### üêõ Bug Fixes
        - Bug fixes and stability improvements
        
        ### üîß Technical Changes
        - Updated dependencies
        - Improved build process
        - Enhanced security
        
        ### üì¶ Artifacts
        - \`{project_name}-${{ steps.version.outputs.version }}.jar\`
        
        **Generated by:** Scaffold Forge Release Workflow" >> $GITHUB_OUTPUT
    
    - name: üéâ Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        release_name: üéâ Release ${{ steps.version.outputs.version }}
        body: ${{ steps.changelog.outputs.changelog }}
        draft: ${{ github.event.inputs.release_type == 'draft' }}
        prerelease: ${{ github.event.inputs.release_type == 'prerelease' }}
    
    - name: üì§ Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/{project_name}-1.0.0.jar
        asset_name: {project_name}-${{ steps.version.outputs.version }}.jar
        asset_content_type: application/java-archive
    
    - name: üìã Release summary
      run: |
        echo "üéâ Release ${{ steps.version.outputs.version }} created successfully!"
        echo "üì¶ Artifact: {project_name}-${{ steps.version.outputs.version }}.jar"
        echo "üîó Release URL: ${{ steps.create_release.outputs.html_url }}"'''
}

def update_visual_workflows():
    """Atualiza os workflows com visualiza√ß√£o EXATA como no GitHub Actions"""
    
    # Ler o arquivo
    with open('backend/server.py', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # Atualizar cada workflow
    for workflow_name, workflow_content in VISUAL_WORKFLOWS.items():
        # Padr√£o para encontrar o workflow
        pattern = rf'("\.github/workflows/{workflow_name}"): \'\'\'(.*?)\'\'\''
        
        # Substituir o workflow
        replacement = rf'\1: \'\'\'{workflow_content}\'\'\''
        content = re.sub(pattern, replacement, content, flags=re.DOTALL)
    
    # Salvar o arquivo atualizado
    with open('backend/server.py', 'w', encoding='utf-8') as f:
        f.write(content)
    
    print("‚úÖ Workflows atualizados com visualiza√ß√£o EXATA do GitHub Actions!")
    print("üîó Estrutura visual implementada:")
    print("   üì¶ CI/CD: job1 ‚Üí job2 ‚Üí job3 ‚Üí [job4, job5] ‚Üí job6")
    print("   üöÄ Release: build-and-test ‚Üí [security-check, create-release]")
    print("   üîÑ Dependabot: check-dependencies (independente)")
    print("   üîí Security: security-scan (independente)")
    print("   üéØ Quality: code-quality (independente)")
    print()
    print("üéØ Agora os workflows t√™m:")
    print("   ‚úÖ Jobs sequenciais conectados (job1 ‚Üí job2 ‚Üí job3)")
    print("   ‚úÖ Jobs paralelos em grupos ([job4, job5])")
    print("   ‚úÖ Depend√™ncias visuais claras (needs: [job1, job2])")
    print("   ‚úÖ Status visual com checkmarks")
    print("   ‚úÖ Dura√ß√£o de cada job")
    print("   ‚úÖ Fluxo de execu√ß√£o como no GitHub Actions")

if __name__ == "__main__":
    update_visual_workflows()
